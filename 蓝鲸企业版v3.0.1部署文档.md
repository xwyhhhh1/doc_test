# 蓝鲸企业版v3.0.1部署文档



机器选型：

1，部署蓝鲸企业版， 需要5 - 23台机器， 建议体验环境5台， 生产环境12台以上。

5台机器最低配置：

cpu：8核=4核4线程

内存：32G

2，机器配置

cpu：32核

内存：64G

操作系统推荐 Centos7



### 基础环境（五台机器都需要做的配置）

1.关闭ipv6

#编辑/etc/sysctl.conf 配置，增加 net.ipv6.conf.all.disable_ipv6=1

#编辑 /etc/sysconfig/network 配置，增加NETWORKING_IPV6=no, 保存并退

#关闭开启自启

ipv6 systemctl disable ip6tables.service



2.时间同步

date -R

yum install -y ntpdate

ntpdate time.asia.apple.com



3.关闭SELinux

#查看SELinux状态

sestatus

#修改

\#sed -i ‘s/^SELINUX=enforcing/SELINUX=disabled/g’ /etc/selinux/config



4.查看防火墙

systemctl status firewalld

#关闭并禁止启动防火墙

systemctl stop firewalld && systemctl disable firewalld



5.停止并禁用NetWorkManager

systemctl stop NetworkManager && systemctl disable NetworkManager



6，设置最大文件打开数

#查看系统最大文件打开数

ulimit -n 

#最后一行加上

vi /etc/security/limits.conf

root soft nofile 102400

root hard nofile 102400




7.检查是否存在全局HTTP代理

#检查http_proxy ,https_proxy 变量是否设置 

echo "$http_proxy" "$https_proxy"



8.配置服务器yum源

#新配置CentOS-Base源

mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak

wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo



#更新配置epel源

mv /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo

yum install -y epel-release



#更新yum缓存

yum clean all

yum makecache fast



9.测试yum安装

yum install -y gcc gcc-c++ wget curl telnet openssl openssl-devel rsync lrzsz



### 在中控机配置

```wiki
1.中控机,解压资源包
cd /data
#解压common组件包
mkdir -p /data
tar -xf bkee_common-3.0.2.tgz -C /data
mv/data/src/yum /opt/

2.解压product包
tar -xf bkee_product-3.0.1-BRANDMAX.tgz -C /data

3.解压安装脚本包
tar -xf install_ee-v3.0.7.tgz -C /data

4.解压证书包
mkdir -p /data/src/cert
tar -xf cert_ee-1.2.5_BRANDMAX.tgz -C /data/src/ce

5.更改配置文件install.configcd /data/install/
mv install.config.5ip.sample install.config

vi install.config
172.16.0.23 license,consul,appo,beanstalk,monitorv3(influxdb-proxy),influxdb(bkmonitorv3),ssm,es7,mongodb,gse,redis,usermgr
172.16.0.25 license,consul,paas,cmdb,beanstalk,monitorv3(influxdb-proxy),monitorv3(monitor),mysql,gse,redis,rabbitmq,appo
172.16.0.6 nginx,zk(config),redis_sentinel,kafka(config),fta,iam,paas,mongodb,monitorv3(transfer),monitorv3(monitor),log(api),log(grafana)
172.16.0.14 nginx,zk(config),redis_sentinel,kafka(config),fta,nfs,influxdb(bkmonitorv3),usermgr,log(api),monitorv3(transfer),job,iam,es7
172.16.0.18 cmdb,job,zk(config),kafka(config),rabbitmq,consul,redis_sentinel,ssm,nodeman(nodeman),monitorv3(grafana),es7,mongodb,appt
6.编辑global.env

#新建global.env文件touch /data/install/bin/03-userdef/global.envchmod +755 global.env 
vi /data/install/bin/03-userdef/global.env

#输入如下图
BK_DOMAIN="yflj.net"
BK_PAAS_PUBLIC_URL="http://paas.yflj.net:80"
BK_PAAS_PUBLIC_ADDR="paas.yflj.net:80"
BK_CMDB_PUBLIC_ADDR="cmdb.yflj.net:80"
BK_CMDB_PUBLIC_URL="http://cmdb.yflj.net:80"
BK_JOB_PUBLIC_ADDR="job.yflj.net:80"
BK_JOB_PUBLIC_URL="http://job.yflj.net:80"
BK_JOB_API_PUBLIC_ADDR="jobapi.yflj.net:80"
BK_JOB_API_PUBLIC_URL="http://jobapi.yflj.net:80"
BK_NODEMAN_PUBLIC_DOWNLOAD_URL="http://nodeman.yflj.net:80"
BK_GSE_WAN_IP_LIST=172.16.0.25,172.16.0.23
BK_PAAS_ADMIN_PASSWORD=Shlz@2401

7.配置pip源touch pip.conf
cd /data/install
# vi install/pip/pip.conf
[global]index-url = https://mirrors.cloud.tencent.com/pypi/simpletrusted-host = mirrors.cloud.tencent.com

8. 验证证书
```

\#登录中控机

cd /data/src/cert

openssl x509 -noout -text -in /data/src/cert/platform.cert | sed -n '/Subject Alternative Name:/{n;p}' | grep -Po '\b([a-z0-9]{2}:){5}[a-z0-9]{2}\b'
fa:16:3e:41:2e:fb fa:16:3e:03:22:22 9.

检查主机mac地址和证书mac地址匹配

ip addr |egrep 'fa:16:3e:03:22:22||fa:16:3e:41:2e:fb'

#注：使用证书组件解压的mac地址会和本机地址不一致，可以下载证书文件进行



10.安装前的环境验证

10.1执行免密，中控机操作

bash /data/install/configure_ssh_without_paas



10.2解压/data/src下的所有模块包

cd /data/src;for f in *gz;do tar -xf$f;done



10.3补齐开源组件

cd /data/src

wget https://github.com/Tencent/TencentKona-8/releases/download/8.0.4-GA/TencentKona8.0.4.b11_jdk_linux-x86_64_8u272.tar.gz

mv TencentKona8.0.4.b11_jdk_linux-x86_64_8u272.tar.gz /data/src/java8.tgz



10.4补job包

mv /root/job.zip /data/src/

unzip job.zip



10.5重启所有节点，检查全部环境

reboot

#看SELinux状态

sestatus

#查时间同步

date -R

#查系统打开文件最大数

ulimit -n 



\#下面的这一项不需要手动操作，在安装Consul组件时，系统会自动增加该项内容!

#添加dns本机

vi /etc/resolv.conf 

nameserver 127.0.0.1



11.资源初始化检查

cd /data/install

./health_check/check_bk_controller.sh 

start<<check_ssh_nopass>> ... [OK]

start<<check_hostname_uniq>> ... [OK]

start<<check_cert_mac>> ... [OK]

start<<check_install_config>> ... [OK]

start<<check_domain>> ... [OK]------##域名/data/install/bin/03-userdef/global.env

start<<check_src_dir>> ... [OK]---------##mv /data/src/yum /opt/

##这里没有任何的报错，就可以继续往下走，有报错先解决报错在继续。



12.安装common

./bk_install common



13.paas部署

./bk_install paas



14.app_mgr部署

./bk_install app_mgr



15.cmdb部署

./bk_install cmdb



16.安装 job 及依赖环境

./bk_install job 



17.安装 bkmonitorv3 及依赖环境（没有蓝盾安装包，先暂时跳过）

./bk_install bkmonitorv3 



18. 安装 bknodeman 及依赖环境

./bk_install bknodeman



19. 安装 bklog 及依赖环境

./bk_install bklog



20. 安装 paas_plugins 及依赖环境

./bk_install paas_plugin



21. 安装 故障自愈后台

./bk_install fta



22.从后台部署 saas 应用

./bk_install saas-o



23.访问验证（每台都要做）

vi /etc/hosts

103.79.25.66 paas.yflj.net cmdb.yflj.net

103.79.25.67 job.yflj.net jobapi.yflj.net

175.102.179.74 nodeman.yflj.net



24.更改域名

安装部署后，BK_DOMAIN默认使用的是bktencent.com，如果需要修改成其他域名。例如换成aiops365.cn

#备份中控机的install目录

tar -cvzf /data/src/backup/install_ce_$(date +%Y%m%d).tgz -C /data install

\# cd /data/install

 ./bin/change_bk_domain.sh yflj.net



#上述脚本运行成功后：

#如果域名是配置的本地hosts文件，清修改本机的hosts文件。

#如果是通过dns解析的，请修改相应的dns解析



#请重新部署所有官方saas

./bkcli install saaa-o

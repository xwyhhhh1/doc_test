## 分布式部署蓝鲸

#### 1.准备环境（以下为三台主机都需要进行的操作）

>特别注意要选择网络好的时间段

+ 关闭防火墙（所有主机均进行）

   ```shell
   systemctl stop firewalld && systemctl disable firewalld
   ```

+ 修改selinux策略

   ```shell
   setenforce 0 && sed -i "s/SELINUX=Enforcing/SELINUX=disabled/g" /etc/selinux/config
   ```

+ 修改文件最大打开数量

   ```shell
   cat > /etc/security/limits.conf << EOF
   root soft nofile 102400
   root hard nofile 102400
   EOF
   
   # linux命令行执行 exit，退出终端连接
   # 再次使用root用户连接linux
   ulimit -n 
   # 查看最大连接数是否修改成功
   ```

+ 安装基础组件

   ```shell
   yum install -y wget curl lrzsz gcc gcc-c++ ntpdate net-tools zip unzip wget
   ```

+ 同步机器时间

   ```shell
   yum -y install ntpdate
   # 不加-d参数较好
   ntpdate -d time.asia.apple.com 
   # ntpdate  time.windows.com
   ```

+ 更改yum源

   ```shell
   # epel
   yum install -y epel-release
   
   # 备份yum仓库
   #请先创建backup
   mv /etc/yum.repos.d/* /root/backup
   
   #update yum 源
   curl -O http://mirrors.aliyun.com/repo/Centos-7.repo && mv /etc/yum.repos.d/Centos-7.repo /etc/yum.repos.d/CentOS-Base.repo
   
   curl -O http://mirrors.aliyun.com/repo/epel-7.repo && mv /etc/yum.repos.d/epel-7.repo /etc/yum.repos.d/epel.repo
   #清空缓存
   yum clean all
   yum makecache fast
   ```
   
+ 安装rsync

   ```shel
   yum -y install rsync
   ```







+ 下载蓝鲸基础产品包，解压到/data/下,解压各个产品包，拷贝rpm

   https://bk.tencent.com/download/

   ```shell
   #中控机 
   wget https://bkopen-1252002024.file.myqcloud.com/ce/bkce_basic_suite-6.0.5.tgz
   #解压缩
   tar -xf xxxxxxxx -C /data
   cd /data/src/; for f in *gz;do tar xf $f; done
   cp -a /data/src/yum /opt
   ```

+ 下载证书包

   https://bk.tencent.com/download_ssl/

   ```shell
   #获取三台机器的mac地址，以英文分号隔开，下载
   ip a
   #解压到/data/src/cert/,创建目录赋予权限解压赋予权限，赋予解压后的文件权限
   install -d -m 755 /data/src/cert
   tar xf /data/ssl_certificates.tar.gz -C /data/src/cert/
   chmod 644 /data/src/cert/*
   ```

+ 准备域名安装目录和登录用户即密码

   ```shell
   # -d 参数为指定兹定于域名，不加-d 默认域名 bktencent.com
   # -p 指定安装路径，默认不加为/data/bkce
   cd /data/install 
   ./configure -d xwy.com -p /data/bkce
   
   # 根据自身情况，蓝鲸默认生成paas密码
   cat > /data/install/bin/03-userdef/usermgr.env << EOF
   BK_PAAS_ADMIN_PASSWORD=BlueKing #修改values值，此处values值为密码
   EOF
   ```

+ 准备install.config文件

   ```shell
   #更改成实际ip
   cat << EOF >/data/install/install.config
   10.0.0.1 iam,ssm,usermgr,gse,license,redis,consul,mysql,lesscode
   10.0.0.2 nginx,consul,mongodb,rabbitmq,appo
   10.0.0.3 paas,cmdb,job,zk(config),appt,consul,nodeman(nodeman)
   EOF
   
   # 或者拷贝一份文件
   cp install.config.3ip.sample  install.config
   # 修改ip
   vim install.config
   ```

+ 执行免密

   ```shell
   cd /data/install
   bash /data/install/configure_ssh_without_pass
   ```

+ 完毕之后开始正式安装

#### 2. 安装部署蓝鲸

+ 初始化并检查环境

   ```shell
   # 运行第一遍安装相关依赖时会报错，但是不输出错误，因此重新运行一遍即可
   ./bk_install common #成功
   ./health_check/check_bk_controller.sh#成功
   ```

+ 安装部署paas平台

   ```shell
   ./bk_install paas #成功
   ```

   + 报错consul部署失败 ，解决办法，查看/etc/resolv.conf ,我的情况为中控机正常，但是其他两台从机，dns成为乱码，修改保持一致之后，问题解决。即使三台dns都出现问题，也不用担心，全部修改成正常的dns解析即可

   + *参考文档* https://bk.tencent.com/s-mart/community/question/5063?type=answer

   + ![image-20220221130152819](http://xwyhhhh1.test.upcdn.net/image-20220221130152819.png)

      + 下载这个软件包失败，初步解决办法为直接yum安装一个cpp

      + ![image-20220221130749054](http://xwyhhhh1.test.upcdn.net/image-20220221130749054.png)

      + > cpp一般指c++

+ 安装部署app_mgr

   ```shell
   ./bk_install app_mgr #成功
   ```

+ 部署权限中心以及用户管理

   ```shell
   # 权限中心
   ./bk_install saas-o bk_iam # 成功
   # 用户管理
   ./bk_install saas-o bk_user_manage#成功
   ```

+ 安装部署cmdb

   ```shell
   ./bk_install cmdb #成功
   ```

+ 安装部署job作业平台

   ```shell
   ./bk_install job #成功
   ```

+ 安装部署 bknodeman

   ```shell
   ./bk_install bknodeman # 成功
   ```

   + 出现问题time out

   + 解决方法：修改相关配置文件

      ```shell
      #修改 paas_agent 模版配置文件的 EXECUTE_TIME_LIMIT 配置项
      vim /data/src/paas_agent/support-files/templates/#etc#paas_agent_config.yaml.tpl
      #修改EXECUTE_TIME_LIMIT=300这一项，改成30000即可
      
      #修改 open_paas 模版配置文件
      vim /data/src/open_paas/support-files/templates/paas#conf#settings_production.py.tpl
      # 在配置文件内任意处新增该配置项。
   EVENT_STATE_EXPIRE_SECONDS = 3600
      
      # paas
      ./bkcli render paas
      ./bkcli restart paas
      # appo
      ./bkcli install appo
      ./bkcli restart appo
      ```
      
   + *参考文档* https://bk.tencent.com/s-mart/community/question/1405

+ 安装部署标准运维和流程管理saas

   ```shell
   # 标准运维
   ./bk_install saas-o bk_sops #成功
   
   # 流程管理
   ./bk_install saas-o bk_itsm #报错，但是好像成功了
   ```

   + ![image-20220215102107926](http://xwyhhhh1.test.upcdn.net/image-20220215102107926.png)

+ 加载蓝鲸相关维护命令和初始化业务拓扑

   ```shell
   source ~/.bashrc
   ./bkcli initdata topo
   ```

+ 检测相关服务状态

   ```shell
   cd /data/install/
   echo bkssm bkiam usermgr paas cmdb gse job consul | xargs -n 1 ./bkcli check
   ```

   

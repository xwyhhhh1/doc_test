## 杉欣数科项目实施技术评估

### 一、CMDB实现评估

#### 1.实现技术

##### 1.1配合蓝鲸套餐包部署实现

###### 1.1.1环境准备

```shel
#关闭防火墙
systemctl stop firewalld && systemctl disable
#如果防火墙为iptables,那么应该清除所有规则
iptables -XFZ 
#关闭selinux策略
setenforce 0 && sed -i "s/SELINUX=Enforcing/SELINUX=disabled/g" /etc/selinux/config
sestatus
#机器环境中应包含epel扩展源和epeo源
curl -O http://mirrors.aliyun.com/repo/Centos-7.repo && mv /etc/yum.repos.d/Centos-7.repo /etc/yum.repos.d/CentOS-Base.repo
curl -O http://mirrors.aliyun.com/repo/epel-7.repo && mv /etc/yum.repos.d/epel-7.repo /etc/yum.repos.d/epel.repo
#请清除缓存和重建缓存
yum clean all
yum makecache fast
#安装cmdb需要正确的时间，请同步时间
ntpdate time.windows.com
#如果没有这条命令，应该先安装命令包
yum -y install ntpdate
#检查时间是否准确
date
#安装蓝鲸时需要rsync的支持，请检查是否安装了rsync
which rsync
#如果报错，请尝试安装
yum -y install rsync
#安装蓝鲸时需要调整文件最大打开数量的限制，请修改
cat > /etc/security/limits.conf << EOF
root soft nofile 102400
root hard nofile 102400
EOF
#退出终端重新连接，查看是否成功
ulimit -n
#检查是否有全局代理
echo $http_proxy $https_proxy


#请确保上述条件在每台机器上完成，这些是基础环境，如果环境准备不到位，可能会导致部署失败。请务必确认！！！
#请检查主机名是否相同，要保证每台的名字不同，请确认此项！！！
```

###### 1.1.2产品准备

```shell
#请确认自己的证书包，是否由部署机器的mac地址生成
#请确认基础套餐包已上传
#请解压基础套餐包到指定路径
tar -xf xxxxxx -C /data/
#请解压产品包
cd /data/src/; for f in *gz;do tar xf $f; done
#请拷贝蓝鲸公共组件的yum仓库到指定目录下
cp -a /data/src/yum /opt
#请创建证书包解压目录，并赋予目录相应权限
install -d -m 755 /data/src/cert
#请将证书包解压到指定目录下
tar xf /data/ssl_certificates.tar.gz -C /data/src/cert/
#请赋予访问证书包的权限
chmod 644 /data/src/cert/*
#请准备自己访问的域名及密码
#请调用脚本指定自己的域名及安装目录，安装目录一般默认为/data/bkce，请不要修改。
cd /data/install && ./configure -d (域名) -p /data/bkce
#请修改values值，为您自己的密码
cat > /data/install/bin/03-userdef/usermgr.env << EOF
BK_PAAS_ADMIN_PASSWORD=BlueKing
EOF
#请准备install.config文件
cp install.config.3ip.sample  install.config
#请将文件中的ip修改成您的实际ip
vim install.config
#若无vim编辑器，请使用vi或安装vim
yum -y install vim
#请执行免密脚本
cd /data/install
bash /data/install/configure_ssh_without_pass


#以上步骤请在中控机上执行，请务必全部完成！！！

```

###### 1.1.3安装部署

```shell
#部署蓝鲸需要公共组件支持，请调用部署脚本部署公共组件
cd /data/install && ./bk_install common
#以上没有报错请调用检查脚本，检查环境是否准确无误
./health_check/check_bk_controller.sh
#环境通过，即可开始部署
#paas为蓝鲸的门户，安装cmdb之前需要先安装门户
./bk_install paas
#paas实现需要另外两个saas的配合，但是saas依赖于正式环境和测试环境，因此请先安装环境
./bk_install app_mgr
#部署依赖saas
./bk_install saas-o bk_user_manage
./bk_install saas-o bk_iam
#实现这些后可以调用脚本部署cmdb
./bk_install cmdb

#请中控机上执行此安装部署命令！！！
```

#### 2.CMDB管控方案实现展示

##### 2.1收集需求清单

| 提供           | 信息 |
| :------------- | ---- |
| 主机ip         |      |
| 服务进程端口   |      |
| 业务名称       |      |
| 实现功能模块   |      |
| 交换机基础信息 |      |
| 各类中间件     |      |
|                |      |

#####2.2模拟实例

###### 2.2.1新建业务

![image-20220406140436007](http://xwyhhhh1.test.upcdn.net/image-20220406140436007.png)

![image-20220406141453676](http://xwyhhhh1.test.upcdn.net/image-20220406141453676.png)

###### 2.2.2新建业务集群

![image-20220406141724830](http://xwyhhhh1.test.upcdn.net/image-20220406141724830.png)

![image-20220406141848575](http://xwyhhhh1.test.upcdn.net/image-20220406141848575.png)

![image-20220406142009579](http://xwyhhhh1.test.upcdn.net/image-20220406142009579.png)

###### 2.2.3新建实现功能模块

![image-20220406142810372](http://xwyhhhh1.test.upcdn.net/image-20220406142810372.png)

###### 2.2.4新建实例

![image-20220410155646692](http://xwyhhhh1.test.upcdn.net/image-20220410155646692.png)

![image-20220410155733485](http://xwyhhhh1.test.upcdn.net/image-20220410155733485.png)

![image-20220410160450034](http://xwyhhhh1.test.upcdn.net/image-20220410160450034.png)

![image-20220410160330137](http://xwyhhhh1.test.upcdn.net/image-20220410160330137.png)

#### 3.技术评估

###### 1.难度：较低

###### 2.注意事项：前期准备环境工作

######3.细节方面请不要忽略

### 二、JOB实现评估

#### 1.实现技术

##### 1.1配合蓝鲸套餐实现安装

###### 1.1.1环境准备

```shell
#job的安装部署需要建立在paas与cmdb安装之后的情况下
```

###### 1.1.2安装部署

```shell
#请参考一cmdb搭建实现,在此基础上搭建job
#请确认一是否成功，成功即可进行job安装
#请调用安装脚本进行部署
cd /data/install/ 
./bk_install job
#请检查执行结果是否报错，如果错误请先排除错误，再尝试重新安装

#以上操作请在中控机上执行！！！
```

####2.JOB方案实现展示

##### 1.清单

| 任务需求       | 脚本     |
| :------------- | -------- |
| 定时任务       | 相关脚本 |
| 数据库备份测试 | 相关脚本 |
|                |          |



##### 2.脚本执行

![image-20220407151034902](http://xwyhhhh1.test.upcdn.net/image-20220407151034902.png)

![image-20220407151611077](http://xwyhhhh1.test.upcdn.net/image-20220407151611077.png)

######2.1说明

- 脚本执行分为手工录入和脚本应用两种
  - 在手工录入中，运维人员可以通过在蓝鲸提供的命令行界面进行基础命令的键入，选择要进行操作的机器来批量执行命令
  - 在脚本应用中，可以引用已在中创建好的脚本，"作业平台==>脚本"并能在下方脚本参数处，进行传参。运维人员可在脚本处新建脚本，在脚本执行中去应用，批量的去进行脚本执行。
- 多种语言支持
  - 蓝鲸作业平台提供，shell脚本执行，bat脚本，perl语言编写脚本，python和sql都支持
  - 手工录入执行只需要选择对应的命令行即可
  - 脚本应用，作业平台会识别脚本类型从而进行执行
- 批量执行

##### 3.文件分发

![image-20220407153138568](http://xwyhhhh1.test.upcdn.net/image-20220407153138568.png)

###### 3.1说明

- 文件分发分为强制模式和严谨模式
  - 强制模式为：不论目标路径是否存在，都将强制按照用户填写的目标路径进行传输（路径不存在会自动创建）。
  - 严谨模式为：严谨判断目标路径是否存在，若不存在将直接终止任务。3.定时任务

##### 4.定时任务

![image-20220407153813720](http://xwyhhhh1.test.upcdn.net/image-20220407153813720.png)

###### 4.1说明

- 定时任务
  - 定时任务模仿linux操作系统保留了原汁原味的界面视图展现，定时任务可以周期执行，也可以单次执行
  - 在周期执行内可以设置结束时间
  - 周期任务会根据作业模板的步骤和提交到执行方案里的流程去进行任务执行。
  - 通过定时任务可以进行日志归档、数据库备份、额外定时删除指定可删数据，这些脚本需要运维人员进行编写，在脚本中。

#####5.脚本编写

![image-20220407155029020](http://xwyhhhh1.test.upcdn.net/image-20220407155029020.png)

###### 5.1说明

- 新建脚本
  - 通过脚本栏目中新建脚本项即可开始建立脚本
  - 脚本也编写支持多种语言
  - 运维人员由此编写相关脚本，配合定时任务完成日志归档、数据库备份、额外定时删除指定可删数据等

#### 3.技术实现评估

###### 1.难度：较低,一人即可完成

###### 2.注意事项：paas、cmdb是否已成功部署

###三、监控平台、故障自愈、日志平台

####1.实现技术

##### 1.1配合蓝鲸套餐，使用saas功能进行安装

###### 1.1.1环境准备

```shell
#此安装需要在二完成的基础上，请先完成二的安装
#请检查二是否安装部署成功
#部署此监控、故障、日志需要基础套餐安装成功因此，请先完成基础套餐的安装
#请调用安装脚本进行节点管理saas的安装
cd install
./bk_install saas-o bknodeman 
#请检查部署saas是否报错，在确认成功的情况下，进行标准运维saas部署
./bk_install saas-o bk_sops
#请检查部署saas是否报错，在确认成功的情况下，进行流程服务saas部署
./bk_install saas-o bk_itsm

#安装此三件需要增强套餐的安装包，请确认您已上传至中控机上并已解压

#请确认以上操作已在中控机上完成!!!

#请在节点管理中确认部署的机器是否已进行agent节点管理，如若没有，见下图
#请在安装节点管理成功后，对将要部署的机器执行免密，请在中控机上执行
#免密成功后，请使用标准运维进行安装
#在蓝鲸6.x版本，已不支持后台进行安装，因此需要标准运维部署，标准运维安装部署需要导入模板，因此，请前往此链接下载模板https://bkopen-1252002024.file.myqcloud.com/ce/bk_sops_co_package-6.0.4.dat
```

![image-20220402165904301](http://xwyhhhh1.test.upcdn.net/image-20220402165904301.png)

###### 1.1.2安装部署

1.导入标准运维模板

![image-20220402171800147](http://xwyhhhh1.test.upcdn.net/image-20220402171800147.png)

2.部署监控平台

![image-20220402171939050](http://xwyhhhh1.test.upcdn.net/image-20220402171939050.png)

![image-20220402172450157](http://xwyhhhh1.test.upcdn.net/image-20220402172450157.png)

![image-20220402172625001](http://xwyhhhh1.test.upcdn.net/image-20220402172625001.png)

3.部署日志平台

![image-20220402172740451](http://xwyhhhh1.test.upcdn.net/image-20220402172740451.png)

![image-20220402172811773](http://xwyhhhh1.test.upcdn.net/image-20220402172811773.png)

![image-20220402172845815](http://xwyhhhh1.test.upcdn.net/image-20220402172845815.png)

4.部署故障自愈

![image-20220402172936143](http://xwyhhhh1.test.upcdn.net/image-20220402172936143.png)

![image-20220402173008904](http://xwyhhhh1.test.upcdn.net/image-20220402173008904.png)

![image-20220402173041676](http://xwyhhhh1.test.upcdn.net/image-20220402173041676.png)

#### 2.监控平台方案实现展示

##### 1.清单

|      |      |
| ---- | ---- |
|      |      |
|      |      |
|      |      |



##### 2.接入主机进行监控

![image-20220407171348351](http://xwyhhhh1.test.upcdn.net/image-20220407171348351.png)

![image-20220409170837849](http://xwyhhhh1.test.upcdn.net/image-20220409170837849.png)

![image-20220409171903753](http://xwyhhhh1.test.upcdn.net/image-20220409171903753.png)

###### 2.1监控进程

![image-20220409180835759](http://xwyhhhh1.test.upcdn.net/image-20220409180835759.png)

![image-20220409181420920](http://xwyhhhh1.test.upcdn.net/image-20220409181420920.png)

###### 2.2说明

- 监控主机需要首先进行agent安装，才能进行监控，对于不能进行安装agent的机器，提供了snmp等其它渠道
- 在仪表盘界面能够查看主机cpu、网络、磁盘io等，也可以对进程进行监控
- 监控进程需要在配置平台对主机添加进程实例

##### 3.拨测服务

###### 3.1添加拨测点

![image-20220410144422752](http://xwyhhhh1.test.upcdn.net/image-20220410144422752.png)

![image-20220410144727314](http://xwyhhhh1.test.upcdn.net/image-20220410144727314.png)

######3.2新建任务

![image-20220410144614113](http://xwyhhhh1.test.upcdn.net/image-20220410144614113.png)

![image-20220410144828535](http://xwyhhhh1.test.upcdn.net/image-20220410144828535.png)

###### 3.3说明

- 服务拨测依赖插件bkmonitorbeat
- 插件版本需要在1.14以上
- 拨测服务支持tcp、udp、http、icmp协议，可在高级选项中，设置期待的返回值
- 拨测服务需要拨测节点，所以请先拥有对应拨测节点的基础上



##### 4.应用服务及中间件监控配置脚本导入

![image-20220410151504131](http://xwyhhhh1.test.upcdn.net/image-20220410151504131.png)

###### 4.1说明

- 编写监控脚本由导入导出项进行导入

#### 3.日志平台方案实现展示

##### 1.日志平台数据接入

###### 1.1ES源接入

![image-20220411131305232](http://xwyhhhh1.test.upcdn.net/image-20220411131305232.png)

![image-20220411105821259](http://xwyhhhh1.test.upcdn.net/image-20220411105821259.png)

![image-20220411131600902](http://xwyhhhh1.test.upcdn.net/image-20220411131600902.png)

###### 1.2采集源接入

![image-20220411130900720](http://xwyhhhh1.test.upcdn.net/image-20220411130900720.png)

![image-20220411131931295](http://xwyhhhh1.test.upcdn.net/image-20220411131931295.png)

![image-20220411132104792](http://xwyhhhh1.test.upcdn.net/image-20220411132104792.png)

##### 2.关键文件日志采集

请参考日志平台数据接入1.2采集源接入

##### 3.关键字检索及警告

![image-20220411133435339](http://xwyhhhh1.test.upcdn.net/image-20220411133435339.png)

![image-20220411133603333](http://xwyhhhh1.test.upcdn.net/image-20220411133603333.png)

![image-20220411134626163](http://xwyhhhh1.test.upcdn.net/image-20220411134626163.png)

![image-20220411135128767](http://xwyhhhh1.test.upcdn.net/image-20220411135128767.png)

![image-20220411135219222](http://xwyhhhh1.test.upcdn.net/image-20220411135219222.png)

#### 4.故障自愈方案实现展示

##### 1.告警信息收敛、整合

![image-20220410151121819](http://xwyhhhh1.test.upcdn.net/image-20220410151121819.png)

![image-20220410151201362](http://xwyhhhh1.test.upcdn.net/image-20220410151201362.png)

##### 2.自愈场景

###### 2.1创建自愈套餐

![image-20220410153431535](http://xwyhhhh1.test.upcdn.net/image-20220410153431535.png)

###### 2.2自定义接入自愈（两个例子）

![image-20220410153858928](http://xwyhhhh1.test.upcdn.net/image-20220410153858928.png)

![image-20220410155020647](http://xwyhhhh1.test.upcdn.net/image-20220410155020647.png)

![image-20220410155119100](http://xwyhhhh1.test.upcdn.net/image-20220410155119100.png)

#### 5.技术实现评估

5.1难度：较低

5.2注意事项：免密，agent的实现
## 学习计划

### 一、awk、sed、grep使用

#### 1.grep

##### 1.1常用参数

| 参数 | 含义                  |
| ---- | --------------------- |
| -E   | 支持正则表达式同egrep |
| -v   | 取反值                |
| -n   | 显示筛选出的值的行号  |

> grep本身支持通配符但不支持正则表达式，所以要加参数-E

##### 1.2教程

- http://www.360doc.com/content/22/0331/16/99071_1024209016.shtml

- https://www.lxlinux.net/2842.html
- https://haokan.baidu.com/v?pd=wisenatural&vid=3193880350735641073（视频）

#### 2.awk

##### 2.1常用参数

| 参数 | 含义                           |
| ---- | ------------------------------ |
| -F   | 指定分隔符                     |
| NR   | 行                             |
| NF   | 计算有几列数据，根据分隔符而定 |
| -f   | 指定awk脚本                    |

##### 2.2教程

- https://blog.csdn.net/KingJin_CSDN_/article/details/108077430
- https://blog.csdn.net/oyinhezhiguang/article/details/115482821
- https://www.cnblogs.com/dusw/p/15992960.html

#### 3.sed

##### 3.1常用参数

| 参数  | 含义                   |
| ----- | ---------------------- |
| -i    | 对文件进行操作         |
| s///g | 替换文本，或者删减文本 |
| -e    | 执行多个sed操作        |
| -f    | 指定sed脚本            |

> sed默认不会对文件内容进行实质性的更改，需要-i参数，才能对文件进行真正意义上的修改。

##### 3.2教程

- https://www.cnblogs.com/liwei0526vip/p/5644163.html
- https://os.51cto.com/article/666465.html
- https://www.yiibai.com/sed/sed_basic_syntax.html

### 二、Shell脚本

#### 1.自动化运维脚本

##### 1.1 博客教程

https://www.jb51.net/article/213879.htm

##### 1.2检测网卡流量脚本

```shell
#!/bin/bash
#######################################################
#检测网卡流量，并按规定格式记录在日志中
#规定一分钟记录一次
#日志格式如下所示:
#2019-08-12 20:40
#ens33 input: 1234bps
#ens33 output: 1235bps
######################################################3
while :
do
#设置语言为英文，保障输出结果是英文，否则会出现bug
LANG=en
logfile=/tmp/`date +%d`.log
#将下面执行的命令结果输出重定向到logfile日志中
exec >> $logfile
date +"%F %H:%M"
#sar命令统计的流量单位为kb/s，日志格式为bps，因此要*1000*8
sar -n DEV 1 59|grep Average|grep ens33|awk '{print $2,"\t","input:","\t",$5*1000*8,"bps","\n",$2,"\t","output:","\t",$6*1000*8,"bps"}'
echo "####################"
#因为执行sar命令需要59秒，因此不需要sleep
done
```

##### 1.3监测Nginx访问日志502情况

```shell
#场景：
#1.访问日志文件的路径：/data/log/access.log
#2.脚本死循环，每10秒检测一次，10秒的日志条数为300条，出现502的比例不低于10%（30条）则需要重启php-fpm服务
#3.重启命令为：/etc/init.d/php-fpm restart
#!/bin/bash
###########################################################
#监测Nginx访问日志502情况，并做相应动作
###########################################################
log=/data/log/access.log
N=30 #设定阈值
while :
do
 #查看访问日志的最新300条，并统计502的次数
    err=`tail -n 300 $log |grep -c '502" '`
 if [ $err -ge $N ]
 then
 /etc/init.d/php-fpm restart 2> /dev/null
 #设定60s延迟防止脚本bug导致无限重启php-fpm服务
     sleep 60
 fi
 sleep 10
done

```



#### 2.部署安装脚本

##### 2.1编译部署nginx

```shell
#!/bin/bash

profile () {
  yum -y install gcc gcc-c++ pcre wget openssl openssl-devel libtool >> /dev/null 2>&1
  cd /usr/local/src && wget https://nginx.org/download/nginx-1.18.0.tar.gz >> /dev/null 2>&1
  useradd nginx -s /sbin/nologin
}
install () {
    tar -xf nginx-1.18.0.tar.gz -C /usr/local/src
    cd /usr/local/src/nginx-1.18.0
    ./configure --prefix=/usr/local/nginx --user=nginx --group=nginx  --with-http_ssl_module  --with-http_stub_status_module >> /dev/null
    if [ $? == 0 ] ;then
       make >> /dev/null && make install >> /dev/null
       cd /usr/local/nginx/sbin && ./nginx || /usr/local/nginx/sbin/nginx
    fi
}
check () {
   yum -y install net-tools >> /dev/null
   NGINX_PORT=$(netstat -tnulp | grep nginx | wc -l)
   NGINX_PROC=$(ps -aux | grep -v grep | grep nginx | wc -l)
   [ $NGINX_PORT -ge 1 ] && echo "端口存在" || echo "端口不存在"
   [ $NGINX_PROC -ge 1 ] && echo "进程存在" || echo "进程不存在"

}
profile
install
check
echo "Install Success!"
```

#####2.2一键部署LDAP脚本

```shell
#!/bin/bash
read -t 10 -p "password: " passwd
echo "<=============>install package.........<================>"
yum install -y openldap openldap-clients openldap-servers >> /dev/null 2>&1
LDAP_PASSWORD=$(slappasswd -s $passwd)
Ldap_Profile () {
    systemctl stop firewalld &&  systemctl disable firewalld >> /dev/null 2>&1
    setenforce 0 && sed -i "s/SELINUX=enforing/SELINUX=disabled/g" /etc/selinux/config
    cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown -R ldap. /var/lib/ldap/DB_CONFIG
    systemctl start slapd
    systemctl enable slapd >> /dev/null 2>&1
}


cat <<EOF >/root/changepwd.ldif
dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: $LDAP_PASSWORD
EOF



cat <<EOF >/root/changedomain.ldif
dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read by dn.base="cn=admin,dc=yaobili,dc=com" read by * none

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=yaobili,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=admin,dc=yaobili,dc=com

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $LDAP_PASSWORD

dn: olcDatabase={2}hdb,cn=config
changetype: modify
add: olcAccess
olcAccess: {0}to attrs=userPassword,shadowLastChange by dn="cn=admin,dc=yaobili,dc=com" write by anonymous auth by self write by * none
olcAccess: {1}to dn.base="" by * read
olcAccess: {2}to * by dn="cn=admin,dc=yaobili,dc=com" write by * read
EOF


cat <<EOF > /root/base.ldif
dn: dc=yaobili,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Yaobili Company
dc: yaobili

dn: cn=admin,dc=yaobili,dc=com
objectClass: organizationalRole
cn: admin

dn: ou=People,dc=yaobili,dc=com
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=yaobili,dc=com
objectClass: organizationalRole
cn: Group
EOF


LDAP_Schema () {
    echo "<=============>ipmort config<==============>"
    cd /root
    ldapadd -Y EXTERNAL -H ldapi:/// -f changepwd.ldif >> /dev/null  2>&1
    ldapmodify -Y EXTERNAL -H ldapi:/// -f changedomain.ldif >> /dev/bull 2>&1
    echo "<=============>import schema.......<================>"
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/collective.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/corba.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/duaconf.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/dyngroup.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/java.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/misc.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/openldap.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/pmi.ldif >> /dev/null 2>&1
    ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/ppolicy.ldif >> /dev/null 2>&1
    echo 'please implement cmd ldapadd -x -D cn=admin,dc=yaobili,dc=com -W -f base.ldif'
}
Ldap_Profile
LDAP_Schema
cat <<EOF
如果以上没有报错，那么就已经完成ldap搭建
base:dc=yaobili,dc=admin,dc=com
user:cn=admin,dc=yaobili,dc=com
password:$passwd
EOF
```



#### 3.系统调优脚本

##### 3.1清除缓存脚本

```shell
#!/bin/bash
mem=$(free -h | awk 'NR==2{print $5}')
echo $mem
cat << EOF
yes
no
EOF
read -t 20 -p "shu ru can shu: " a
case ${a} in
   yes)
      echo 3 > /proc/sys/vm/drop_caches
      echo "<==========cleaning==========>"
      echo "$( free -h | awk 'NR==2{print $4}')"
      echo "<<==========END===========>"
;;
   no)
      echo "<===========thanks===========>"
      echo "$( free -h | awk 'NR==2{print $4}')"
;;
   *)
      echo "can shu bu zheng que"
      exit 1
esac
```

##### 3.2内核参数优化

```shell
#参考此教程https://blog.csdn.net/weixin_40470303/article/details/80716220
```

### 三、常用命令

#### 1.

#### 2.

#### 3.

#### 4.

#### 5.

#### 6.

#### 7.

#### 8.

#### 9.

## 蓝鲸社区版部署

### 一. 部署前的环境准备

1.yum 源配置

一般默认情况下我们创建虚拟机的yum源为CentOS自带的，基于`互联互通`或者`GWT`访问速度慢，可以更改为阿里云的源或者腾讯云的源

```shell
# 安装epel源
yum install -y epel-release

# 更换Base 、Epel源配置
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.cloud.tencent.com/repo/centos7_base.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.cloud.tencent.com/repo/epel-7.repo

# 更新缓存
yum clean all
yum makecache fast
```

2.关闭SELinux

```shell
# 临时关闭
setenforce 0
# 检查临时关闭，如果输出结果为
getenforce

# 永久关闭，根据实际情况考虑是否重启服务器，只要执行了setenforce 0 ，可以暂时不用重启服务器
sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
```

3.关闭firewalld

```shell
# firewalld 是CentOS7之后有的防火墙，CentOS之前使用iptables
# 查看firewalld运行状态
firewall-cmd --state
systemctl status firewalld

# 停止firewalld 并禁止开机自启
systemctl stop firewalld && systemctl disable firewalld
```

4.安装基础组件rpm包

```shell
# 如果OS是最小化安装，则会没有curl wget ntpdate 命令是没有的
yum install -y wget curl ntpdate net-tools lrzsz openssl openssl-devel gcc gcc-c++
```

5.安装rsync 分发同步

```shell
# 首先检查是否有rysnc命令
which rsync

#安装rsync
yum install -y rsync
```

6.调整最大文件打开数

```shell
# 检查最大文件打开数，使用root账号登陆执行如下命令，如果输出的值是1024则需要调整
ulimit -n

# 调整最大文件打开数
cat >> /etc/security/limits.conf <<EOF
root soft nofile 102400
root hard nofile 102400
EOF

# 修改后，输入命令exit退出当前终端连接，然后再登陆Linux系统
ulimit -n 
# 如果输出的值为102400,则修改成功，反之不成功，检查操作步骤
```

7.同步服务器时间

```shell
# time.windows.com || time.asia.apple.com
ntpdate time.asia.apple.com
```

8.检查是否存在全局HTTP代理

```shell
echo "$http_proxy" "$https_proxy"
```

9.检查主机名

```shell
# 修改主机名
hostnamectl set-hostname <新主机名>
bash
```

10.检查DNS配置文件

```shell
# 检查文件属性,如果有 -i 属性，则需要解除
lsattr /etc/resolv.conf

# 解除-i 属性
chattr -i /etc/resolv.conf
```

11.关闭ipv6

```shell
# 部署蓝鲸consul组件时，如果OS开启了ipv6会影响consul服务的启动，所以需要将ipv6关闭
# 关闭ipv6
vi /etc/sysctl.conf
net.ipv6.conf.all.disable_ipv6 =1
net.ipv6.conf.default.disable_ipv6 =1
# 刷新
sysctl -p
```

12.准备蓝鲸相关软件包

```shell
# 1.下载蓝鲸基础套餐组件包 https://bk.tencent.com/download/
# 2.ip addr 命令获取MAC地址，并申请证书https://bk.tencent.com/download_ssl/
# 3.解压蓝鲸基础套餐软件包 tar -xf bkce_basic*tgz -C /data
# 4.解压各个产品组件包 cd /data/src; for f in *gz;do tar -xf $f;done
# 5.拷贝rpm 包 cp /data/src/yum /opt/
```

13.准备证书文件

```shell
install -d -m 755 /data/src/cert
tar -xf /data/ssl_certificates.tar.gz -C /data/src/cert/
chmod 644 /data/src/cert/*
```



### 二. 单机版部署

基础套餐包含：PaaS 平台、配置平台、作业平台、权限中心、用户管理、节点管理、标准运维、流程服务。

1.修改安装文件

```shell
cd /data/install/
sed -i '/start job/i\\t./pcmd.sh\ -m\ job\ \"sed -i '\'/JAVA_OPTS/c\ JAVA_OPTS="-Xms128m -Xmx128m"\'\ /etc/sysconfig/bk-job-*\" bk_install
```

# 自定义密码和域名

2.执行安装

```shell
cd /data/install
# 全部安装
./install_minibk -y
```

3.执行降低消耗内存的脚本

```shell
bash bin/single_host_low_memory_config.sh tweak all
```

4.加载蓝鲸的相关维护命令

```shell
source ~/.bashrc
```

5.初始化业务拓扑

```shell
./bkcli initdata topo
```

6.修改域名解析文件

+ windows

   + C:\Windows\System32\drivers\etc\hosts

   + ip paas.bktencent.com cmdb.bktencent.com job.bktencent.com  jobapi.bktencent.com

      ip nodeman.bktencent.com

+ linux

   + /etc/hosts

   + ```bash
      ip paas.bktencent.com cmdb.bktencent.com job.bktencent.com jobapi.bktencent.com
      ip nodeman.bktencent.com
      ```

7.获取管理员用户和密码

+  ```shell
   grep -E "BK_PAAS_ADMIN_USERNAME|BK_PAAS_ADMIN_PASSWORD" /data/install/bin/04-final/usermgr.env
   ```

8.访问蓝鲸

+ 打开浏览器输入http://paas.bktencent.com

### 三. 分布式部署

基础套餐包含：PaaS 平台、配置平台、作业平台、权限中心、用户管理、节点管理、标准运维、流程服务。

1.准备自定义域名,修改自定义密码

```shell
cd /data/install
./configure -d www.xxx.com -p /data/bkce

cat > /data/install/bin/03-userdef/usermgr.env <<EOF
BK_PAAS_AFMIN_PAASWORD=XXXXXX
EOF
```

2.准备install.config

```shell
cd /data/install
cp install.config.3ip.sample install.config
# 修改成实际ip
vim install.config
```

3.执行免密

```shell
cd /data/install
bash /data/install/configure_ssh_without_pass
```

4.初始化并检查环境

```shell
cd /data/install
./bk_install common
./health_check/check_bk_controller.sh
```

5.安装paas平台

```sell
/data/install/bk_install paas
```

6.安装部署appr_mgr

```shell
/data/install/bk_install appr_mgr
```

7.部署权限中心以及用户管理

```shell
/data/install/bk_install saas-o bk_iam
/data/install/bk_install saas-o bk_user_manage
```

8.安装部署cmdb

```shell
/data/install/bk_install cmdb
```

9.安装部署job作业平台

```shell
/data/install/bk_install job
```

10.安装部署bknodman

```shell
/data/install/bk_install bk_nodeman
```

11.安装部署标准运维和流程管理

```shell
/data/install/bk_install saas-o bk_sops
/data/install/bk_install saas-o bk_itsm
```

12.加载蓝鲸相关维护命令和初始化业务拓扑

```
source ~/.bashrc
/data/install/bkcli initdata topo
```

13.检测相关服务状态

```shell
cd /data/install
echo bkssm bkiam usermgr paas cmdb gse job consul | xargs -n 1 ./bkcli check
```




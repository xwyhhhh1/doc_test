##电信安全漏洞处理手册V2022-05-30

### 说明

**该漏洞处理解决方案由我方根据漏洞扫描报告而提供，并非蓝鲸官方提供，对系统的可用性并不保障，并且出现服务不可用问题也并非腾讯蓝鲸社区版**

**该手册下的所有操作建议都在进行快照后执行**

**该手册的处理方案仅仅只是解决扫描出来的漏洞问题，对于漏洞处理过后蓝鲸系统的可用性并不保障**

### 1.Python漏洞解决

**漏洞信息汇总：**

| 序号 | python漏洞                                                   |
| ---- | ------------------------------------------------------------ |
| 1    | Python 信任管理问题漏洞(CVE-2019-9636)                       |
| 2    | CPython 数字错误漏洞(CVE-2017-1000158)                       |
| 3    | Python 信任管理问题漏洞(CVE-2019-10160)                      |
| 4    | python 安全漏洞(CVE-2016-9063)                               |
| 5    | Python 输入验证错误漏洞(CVE-2016-5636)                       |
| 6    | Python 安全特征问题漏洞(CVE-2019-9948)                       |
| 7    | Python 资源管理错误漏洞(CVE-2018-14647)                      |
| 8    | Python 资源管理错误漏洞（CVE-2018-1061）                     |
| 9    | Python email.utils.parseaddr安全漏洞（CVE-2019-16056）       |
| 10   | python libexpat 安全漏洞(CVE-2017-9233)                      |
| 11   | Python 资源管理错误漏洞（CVE-2018-1060）                     |
| 12   | Python 资源管理错误漏洞(CVE-2020-8492)                       |
| 13   | Python‘bufferobject.c’整数溢出漏洞(CVE-2014-7185)            |
| 14   | Python 跨站脚本漏洞(CVE-2019-16935)                          |
| 15   | Python 注入漏洞(CVE-2019-18348)                              |
| 16   | Python CGIHandler httpoxy 安全漏洞(CVE-2016-1000110)         |
| 17   | Python 'urrlib2/urllib/httplib/http.client' HTTP标头注入漏洞(CVE-2016-5699) |
| 18   | python Redis Labs Redis和Python 注入漏洞(CVE-2019-9740)      |
| 19   | python Redis Labs Redis和Python 注入漏洞(CVE-2019-9947)      |
| 20   | Python和simplejson _json模块信息泄露漏洞(CVE-2014-4616)      |
| 21   | Python 输入验证错误漏洞(CVE-2018-20852)                      |
| 22   | Python asyncore模块设计错误漏洞(CVE-2010-3492)               |
| 23   | python Expat library多个拒绝服务漏洞(CVE-2012-0876)          |
| 24   | Python SSL模块安全绕过漏洞(CVE-2013-4238)                    |
| 25   | Python 加密问题漏洞(CVE-2013-7040)                           |

**解决策略**

- 针对于蓝鲸使用的python2.7.10漏洞处理方法为，统一升级为python2.7.18版本
- 针对蓝鲸使用的python另一版本3.6.10漏洞，统一升级为python3.10.4版本

**操作步骤**

```shell
#主机ip:10.10.9.30、10.10.9.31、10.10.9.32
#升级python27
cd /opt
#下载升级包
wget http://103.161.254.166:8080/py27.tgz
#备份原始python27
mv py27 py27.ori
#比对md5值，确认无误再行解压
md5sum py27.tgz
tar -xf py27.tgz
cd /opt/py27/bin/
#查看是否能够进入python，验证python是否正常
python
#此为退出python
exit()

#升级puthon36
cd /opt
#下载升级包
wget http://103.161.254.166:8080/py36.tgz
#备份原始python27
mv py36 py36.ori
#比对md5值，确认无误再行解压
md5sum py36.tgz
tar -xf py36.tgz
cd /opt/py36/bin/
#python命令默认为python3但在蓝鲸python环境中是python因此需要事先建立软链接
ln -s python3 /opt/py36/bin/python
#查看是否能够进入python，验证python是否正常
python
#此为退出python
exit()


#操作完成后即完成python升级，请查看是否对蓝鲸系统产生影响
#压缩包md5值，请使用md5sum检测文件是否与下列值相符合
bce8f3ea2813a6e735950e489eac5ce8  py27.tgz
2390e051c47d3ca7927a2a628b9636f4  py36.tgz
```



### 2.mysql漏洞解决

**漏洞信息汇总：**

| 序号 | MySQL Server安全漏洞                                         |
| ---- | ------------------------------------------------------------ |
| 1    | Oracle MySQL Server安全漏洞(CVE-2019-17543)                  |
| 2    | Oracle MySQL Server安全漏洞(CVE-2021-22901)                  |
| 3    | Oracle MySQL Server 安全漏洞(CVE-2020-1967)                  |
| 4    | Oracle MySQL/MariaDB Server 输入验证错误漏洞（CVE-2021-2144） |
| 5    | Oracle MySQL Server InnoDB 安全漏洞(CVE-2020-14775)          |
| 6    | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2202)          |
| 7    | Oracle MySQL Server/MariaDB Server: FTS组件拒绝服务漏洞(CVE-2020-14765) |
| 8    | Oracle MySQL Server Server: Optimizer 安全漏洞(CVE-2020-14769) |
| 9    | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2178)          |
| 10   | Oracle MySQL Server/MariaDB 组件安全漏洞(CVE-2020-2780)      |
| 11   | Oracle MySQL Server 安全漏洞(CVE-2020-14539)                 |
| 12   | Oracle MySQL Server 安全漏洞(CVE-2020-14576)                 |
| 13   | Oracle MySQL Server Server: Security: LDAP Auth 安全漏洞(CVE-2020-14827) |
| 14   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2307)          |
| 15   | Oracle MySQL Server 代码问题漏洞(CVE-2020-1971)              |
| 16   | Oracle Java SE 输入验证错误漏洞 (CVE-2021-23841)             |
| 17   | Oracle MySQL Server 输入验证错误漏洞（CVE-2021-23890）       |
| 18   | Oracle MySQL Server 远程安全漏洞(CVE-2021-3449)              |
| 19   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2356)          |
| 20   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2390)          |
| 21   | Oracle MySQL/MariaDB 拒绝服务漏洞(CVE-2021-2011)             |
| 22   | Oracle MySQL Server组件安全漏洞(CVE-2020-2804)               |
| 23   | Oracle MySQL Server/MariaDB InnoDB组件安全漏洞(              |
| 24   | Oracle MySQL Server Server Optimizer                         |
| 25   | Oracle MySQL Server/MariaDB 安全漏洞(CVE-2020-14550)         |
| 26   | Oracle MySQL Server 输入验证错误漏洞（CVE-2021-23853）       |
| 27   | Oracle MySQL Server 输入验证错误漏洞（CVE-2021-23853）       |
| 28   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2169)          |
| 29   | Oracle MySQL Server 安全漏洞(CVE-2020-2763)                  |
| 30   | Oracle MySQL Server/MariaDB Server: Stored Procedure组件安全漏洞(CVE-2020-2812) |
| 31   | Oracle MySQL Server组件安全漏洞(CVE-2020-2765)               |
| 32   | Oracle MySQL Server 安全漏洞(CVE-2020-14540)                 |
| 33   | Oracle MySQL Server 安全漏洞(CVE-2020-14547)                 |
| 34   | Oracle MySQL Server 安全漏洞(CVE-2020-14567)                 |
| 35   | Oracle MySQL Server/MariaDB InnoDB 安全漏洞(CVE-2020-14776)  |
| 36   | Oracle MySQL Server/MariaDB 拒绝服务漏洞(CVE-2020-14789)     |
| 37   | Oracle MySQL Server 安全漏洞(CVE-2020-14869)                 |
| 38   | Oracle MySQL Server 安全漏洞(CVE-2020-14790)                 |
| 39   | Oracle MySQL Server Server: Stored Procedure 安全漏洞(CVE-2020-14672) |
| 40   | Oracle MySQL Server/MariaDB Server: Locking 安全漏洞(CVE-2020-14812) |
| 41   | Oracle MySQL Server Server：Optimizer 安全漏洞(CVE-2020-14793) |
| 42   | Oracle MySQL 安全漏洞(CVE-2021-2060)                         |
| 43   | Oracle MySQL 安全漏洞(CVE-2021-2001)                         |
| 44   | Oracle MySQL 安全漏洞(CVE-2021-2014)                         |
| 45   | Oracle MySQL 输入验证错误漏洞(CVE-2021-2160)                 |
| 46   | Oracle MySQL/MariaDB Server 输入验证错误漏洞(CVE-2021-2180)  |
| 47   | Oracle MySQL/MariaDB Server 输入验证错误漏洞(CVE-2021-2194)  |
| 48   | Oracle MySQL/MariaDB Server 输入验证错误漏洞(CVE-2021-2166)  |
| 49   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2179)          |
| 50   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2226)          |
| 51   | Oracle MySQL Server 输入验证错误漏洞（CVE-2021-2146）        |
| 52   | Oracle MySQL/MariaDB Server 输入验证错误漏洞(CVE-2021-2154)  |
| 53   | Oracle MySQL 输入验证错误漏洞(CVE-2021-2342)                 |
| 54   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2372)          |
| 55   | Oracle MySQL/MariaDB 安全漏洞(CVE-2021-2022)                 |
| 56   | Oracle MySQL Server 授权问题漏洞(CVE-2020-14867)             |
| 57   | Oracle MySQL/MariaDB Server 输入验证错误漏洞(CVE-2021-2174)  |
| 58   | Oracle MySQL Server 输入验证错误漏洞(CVE-2021-2171)          |
| 59   | Oracle MySQL Server 安全漏洞(CVE-2020-14559)                 |
| 60   | Oracle MySQL/MariaDB 访问控制错误漏洞(CVE-2021-2032)         |
| 61   | Oracle MySQL Server 安全漏洞(CVE-2020-14553)                 |
| 62   | Oracle MySQL Server 输入验证错误漏洞（CVE-2021-21622）       |
| 63   | Oracle MySQL 安全漏洞(CVE-2021-2010)                         |

**解决策略**

- 针对于蓝鲸mysql数据库漏洞问题，升级mysql版本至5.7.37

**操作步骤**

```shell
#主机ip，mysql主机:10.10.9.30
#上传压缩包mysql-5.7.37-1.el7.x86_64.rpm-bundle.zip
mkdir -p /usr/local/src/mysql
cd /usr/local/src/mysql
wget http://103.161.254.166:8080/mysql-5.7.37-1.el7.x86_64.rpm-bundle.zip
#查看该包的md5值
#解压目录,包内应包含六个rpm包
unzip mysql-5.7.37-1.el7.x86_64.rpm-bundle.zip
#进行升级操作
yum localinstall mysql-community-*.rpm
#进入中控机重启mysql
ssh $(cat /data/install/.controller_ip)
cd /data/install
source utils.fc
./bkcli restart mysql
#查看数据库密码，查看BK_MYSQL_ADMIN_PASSWORD字段
cat /data/install/bin/01-generate/dbadmin.env 
#进入mysql查看版本
cd /data/install && source utils.fc
ssh $BK_MYSQL_IP
mysql -uroot -p -S /run/mysql/default.mysql.socket
#进入到mysql执行以下命令,输出如下图所示
select version();

#MD5值
287c0a409c9a7a52d1d8dcfeadbf3ab7  mysql-5.7.37-1.el7.x86_64.rpm-bundle.zip
```

![image-20220530192405549](http://xwyhhhh1.test.upcdn.net/image-20220530192405549.png)

### 3.zookeeper漏洞解决

**漏洞信息汇总：**

| 序号 | zookeeper安全漏洞    |
| :--- | -------------------- |
| 1    | ZooKeeper 未授权访问 |

**解决策略**

- 针对蓝鲸zookeeper未授权访问的漏洞问题，予以增加用户

**操作步骤**

```shell
#主机ip,zookeeper主机10.10.9.32
ssh 10.10.9.32
#进入zookeeper客户端
/opt/zookeeper/bin/zkCli.sh -server 10.10.9.32:2181
#执行以下命令添加用户和权限
addauth digest zgdx:!QAZ2wsx
setAcl / auth:zgdx:!QAZ2wsx:cdrwa 
quit

ssh $(cat /data/install/.controller_ip)
cd /data/install/ && source utils.fc
./bkcli restart zk
```

### 4.SSL漏洞解决

**漏洞信息汇总：**

| 序号 | ssl/tls协议漏洞                                              | 备注   |
| ---- | ------------------------------------------------------------ | ------ |
| 1    | SSL/TLS协议信息泄露漏洞(CVE-2016-2183)                       |        |
| 2    | SSL/TLS RC4 信息泄露漏洞(CVE-2013-2566)                      | 系误报 |
| 3    | SSL/TLS 受诫礼(BAR-MITZVAH)攻击漏洞(CVE-2015-2808)-（系误报已解决） | 系误报 |

**解决策略**

- 针对SSL/TLS协议信息泄露漏洞(CVE-2016-2183)，进行升级openssl至新版本OpenSSL_1_1_1o
- SSL/TLS RC4 信息泄露漏洞(CVE-2013-2566)，此为误报，nginx算法并未采用rc4算法

**操作步骤**

- SSL/TLS协议信息泄露漏洞(CVE-2016-2183)

1.确认当前的openssl版本

```shell
#主机ip，10.10.9.30、10.10.9.31、10.10.9.32
#三台机器需要全部执行升级openssl操作
openssl version -a
--
# 输出信息如下：
OpenSSL 1.0.2k  26 Jan 2017
built on: reproducible build, date unspecified
platform: linux-x86_64
options:  bn(64,64) rc4(16x,int) des(idx,cisc,16,int) idea(int) blowfish(idx) 
compiler: gcc -I. -I.. -I../include  -fPIC -DOPENSSL_PIC -DOPENSSL_THREADS -D_REENTRANT -DDSO_DLFCN -DHAVE_DLFCN_H -Wa,--noexecstack -m64 -DL_ENDIAN -O3 -Wall -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DRC4_ASM -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DMD5_ASM -DAES_ASM -DVPAES_ASM -DBSAES_ASM -DWHIRLPOOL_ASM -DGHASH_ASM -DECP_NISTZ256_ASM
OPENSSLDIR: "/opt/py36/openssl"

# 可见当前OpenSSL版本为 1.0.2k
```

2.升级OpenSSL准备工作

```shell
# 1.安装需要组件包
yum install -y  zlib zlib-devel gcc gcc-c++ perl

# 2.下载openssl最新源码包
cd /root/
wget https://github.com/openssl/openssl/archive/refs/tags/OpenSSL_1_1_1o.tar.gz
```

3.升级OpenSSL

```shell
cd /root
tar xf OpenSSL_1_1_1o.tar.gz
cd OpenSSL_1_1_1o
./config 
echo $?
---
# 如果输出为0，表示上面的命令执行成功
make && make install 
echo $?
# 如果输出为0，表示上面的命令执行成功
```

4.配置升级后的OpenSSL

```shell
# 备份OpenSSL
mv /opt/py36/bin/openssl /opt/py36/bin/openssl.ori

# 创建新OpenSSL软连接
ln -s /usr/local/bin/openssl /opt/py36/bin/openssl

#将新的库文件地址写入记录so库的配置文件
echo "/usr/local/lib64" >> /etc/ld.so.conf  

#设置生效
ldconfig -v
```

5.验证OpenSSL

```shell
# 确认OpenSSL PATH路径
[root@bk1 ~]# which  openssl
/opt/py36/bin/openssl

# 确认OpenSSL 最新版本
[root@bk1 ~]# openssl version -a
OpenSSL 1.1.1o  3 May 2022
built on: Tue May 31 11:39:13 2022 UTC
platform: linux-x86_64
options:  bn(64,64) rc4(16x,int) des(int) idea(int) blowfish(ptr) 
compiler: gcc -fPIC -pthread -m64 -Wa,--noexecstack -Wall -O3 -DOPENSSL_USE_NODELETE -DL_ENDIAN -DOPENSSL_PIC -DOPENSSL_CPUID_OBJ -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DKECCAK1600_ASM -DRC4_ASM -DMD5_ASM -DAESNI_ASM -DVPAES_ASM -DGHASH_ASM -DECP_NISTZ256_ASM -DX25519_ASM -DPOLY1305_ASM -DNDEBUG
OPENSSLDIR: "/usr/local/ssl"
ENGINESDIR: "/usr/local/lib64/engines-1.1"
Seeding source: os-specific
```

- SSL/TLS RC4 信息泄露漏洞(CVE-2013-2566)

```shell
#此漏洞为误报，nginx并未采用RC4加密算法
#使用以下命令进行查询，查看字样中是否包括RC4字样
nmap -sV --script ssl-enum-ciphers -p 443 paas.bks.com
#下图为nginx采用算法配置
```



![image-20220531201923033](http://xwyhhhh1.test.upcdn.net/image-20220531201923033.png)

### 5.mongodb漏洞解决

**漏洞信息汇总：**

| 序号 | mongodb安全漏洞                                |
| ---- | ---------------------------------------------- |
| 1    | MongoDB Server 安全漏洞(CVE-2020-7923)         |
| 2    | Mongodb Server 输入验证错误漏洞(CVE-2019-2392) |

**解决策略**

- 针对蓝鲸mongodb4.2.3安全漏洞问题，升级mongodb至4.2.20

操作步骤

```shell
#主机ip，mongodb主机10.10.9.31
ssh 10.10.9.31
mkdir -p /usr/local/src/mongodb
cd /usr/local/src/mongodb
#获取mongodb4.2.20相关rpm包
wget http://103.161.254.166:8080/mongodb.zip
#解压压缩包
unzip mongodb.zip
#升级mongodb至4.2.20
yum localinstall mongodb-org*.rpm
#进入中控机重启mongodb
ssh $(cat /data/install/.controller_ip)
cd /data/install
./bkcli restart mongodb
#检查mongodb版本
source utils.fc
ssh $BK_MONGODB_IP
mongo
#进入mongodb之后执行以下命令，结果如下图
db.version()

#MD5值
4c89bbdd45db47098da20ab77ab7950d  mongodb.zip
```

![image-20220530211333992](http://xwyhhhh1.test.upcdn.net/image-20220530211333992.png)

### 6.rabbitmq漏洞解决

**漏洞信息汇总**

| 序号 | rabbitmq安全漏洞                         |
| ---- | ---------------------------------------- |
| 1    | RabbitMQ输入验证错误漏洞(CVE-2021-22116) |

**解决策略**

- 针对蓝鲸rabbitmq3.8.3安全漏洞问题，升级rabbitmq至3.8.30版本

**操作步骤**

```shell
#主机ip，rabbitmq主机，10.10.9.31
ssh 10.10.9.31
mkdir -p /usr/local/src/rabbitmq
cd /usr/local/src/rabbitmq
#下载压缩包或者上传压缩包rabbitmq.zip
wget http://103.161.254.166:8080/rabbitmq.zip
#解压软件包
unzip rabbitmq.zip
mv  rabbitmq-server-3.8.30-1.el7.noarch.rpm ../
#进行依赖升级操作，忽略各项依赖关系进行安装
rpm -Uvh *.rpm --force --nodeps 
#进行rabbitmq升级操作
mv ../rabbitmq-server-3.8.30-1.el7.noarch.rpm ./
yum localinstall rabbitmq-server-3.8.30-1.el7.noarch.rpm
#查看版本
rpm -qa | grep rabbitmq

#重启rabbitmq
ssh $(cat /data/install/.controller_ip)
cd /data/install
./bkcli restart rabbitmq


#md5值
eef17b9c275a561160d57f25f1843063  rabbitmq.zip
```



### 7.apache漏洞解决

**漏洞信息汇总：**

| 序号 | apache安全漏洞                                         | 备注   |
| ---- | ------------------------------------------------------ | ------ |
| 1    | Apache Shiro RememberMe 1.2.4 反序列化过程命令执行漏洞 | 系误报 |

**解决策略**

- 此漏洞提示为Apache Shiro<1.2.4版本会产生安全威胁，但实际上蓝鲸采用的为1.9.0版本，与报告不符，因此认定为误报

**操作步骤**

```shell
#主机ip，网络管理主机
cd /data/install
source utils.fc 
ssh $BK_NETWORK_IP
#可下载文件打开进行查看，路径如下，此nop.jar中Apache Shiro均为1.9.0
cd /data/bkce/bknetwork/nop/nop.jar
#下图为nop.jar中的内容
```

![image-20220531220820055](http://xwyhhhh1.test.upcdn.net/image-20220531220820055.png)



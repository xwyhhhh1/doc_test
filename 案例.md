## 案例

### paas

+ 蓝鲸server端某台主机重启，paas无法登陆
   + ![img](http://xwyhhhh1.test.upcdn.net/--d2bf9fcc667398eecff8de7dbb0ade5d.png)
   + 解决方案：无法解析到usermgr，在usermgr机器/etc/resolv.conf首行添加 nameserver 127.0.0.1

+ 修改访问端口后，访问paas时报错
   + <img src="http://xwyhhhh1.test.upcdn.net/--9f5d75ab5156a270a098473236e1bad1.png" alt="img" style="zoom:80%;" />
   + 解决方案
      + head -50 /usr/local/openresty/nginx/conf/conf.d/paas.conf | tail
         nginx机器执行
         发现paas的端口没有修改对，重新修改下即可

+ admin登录密码忘记，如何重置密码

   + 登录到usermgr 模块所在服务器执行以下命令，设修改密码为admin
      workon usermgr-api
      export BK_FILE_PATH="/data/bkce/usermgr/cert/saas_priv.txt"
      export DJANGO_SETTINGS_MODULE=“config.ce.prod”
      python manage.py shell

      from bkuser.profiles.models import Profile
      from django.contrib.auth.hashers import make_password
      admin = Profile.objects.get(username=‘admin’, domain=‘default.local’)
      admin.password = make_password(“admin”)
      admin.save()

### 节点管理

+ 新增主机agent，节点管理出现is not  connect to gse server
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--411c9f865a3f583783a5a0a0603a8538.png)
   + 解决方案：重启gse服务，再次手动执行添加Agent
+ 重启agent过程中中重启gseccmfline插件失败command is empty
   + <img src="http://xwyhhhh1.test.upcdn.net/--9964eff9088f03317286fc94a9809630.png" alt="image.png" style="zoom: 50%;" />
   + 解决方案： gsecmdline 是蓝鲸监控脚本采集，自定义监控采集器，当前主机没有在监控平台做相应的配置无法启动，且无需启动该进程

+ exceptionbrat插件采集下发失败，Script exit code non-zero. Error msessage:
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--eb258fba8de724198d9c897d803802e1.png)
   + 解决方案：查看日志Cannot lock “/var/run/gse/exceptionbeat.pid”, reason: Locked by other process[exceptionbeat] init failed with error: Locked by other process
      + 可尝试删除此pid，/var/run/gse/exceptionbeat.pid，或者手动停止exceptionbeat的进程
         /usr/local/gse/plugins/bin/stop.sh exceptionbeat
      + 然后再执行采集下发

### cmdb

+ 配置平台删除主机失败
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--dc1deaa1006593dbe6fb71247b13a5fa.png)
   + 解决方案重启cmdb即可
+ cmdb运行一段时间后报错
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--55404aabee7a33e5d5aed4937803435e.png)
   + 解决办法：./bkcli restart cmdb
+ 机器重启过后访问cmdb页面提示502
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--2eda85b5f4ed5b33d3379bce89f71c90.png)
   + 解决方案重启蓝鲸
      + 具体参照https://bk.tencent.com/docs/document/6.0/127/7582解决

### 监控平台

+ 访问监控saas报错can't start new thread

   + ![img](http://xwyhhhh1.test.upcdn.net/--baade4591be5962924bc35fb9de7dff3.png)

   + 解决方案：ocker容器里部署SaaS时会使用su -m apps -c '/build/starter' 命令启动进程，su 到apps的时候，会触发pam机制读取apps账户的nproc限制，而centos7镜像默认给普通用户的都是4096（可以用在容器内cat /etc/security/limits.d/20-nproc.conf确认）
      所以解决方法在不更好镜像的前提下修改 $BK_HOME/paas_agent/paas_agent/etc/build/docker/saas/builder脚本

      在最后这行su -m apps -c '/build/starter'之前插入一行：echo "apps soft nproc 102400" >> /etc/security/limits.d/20-nproc.conf，然后重新部署SaaS



+ 监控平台添加插件出现问题
   + ![img](http://xwyhhhh1.test.upcdn.net/--3705fdbf8999bebe45cb44edc85aadd3.png)
   + 报错为轮询插件包注册任务超时，请检查节点管理celery是否正常运行
   + 解决方案：查看nodeman节点是否正常，再看rabbitmq是否挂掉了./bkcli status rabbitmq，在没挂的情况下重启nodeman，./bkcli restart nodeman
+ 监控平台采集状态显示无数据上报
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--bc84a0bdc4e91c99733565f80f285e45.png)
   + 解决办法：（用户负载和监控数据情况 检查均正常）重启监控平台， ./bkcli restart bkmonitorv3

### 日志平台

+ 文件分发失败
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--e5e0deb9f226eda57ccdf5625057e752.png)
   + 错误：主机未注册
   + 解决办法，配置ip白名单
      + ![image.png](http://xwyhhhh1.test.upcdn.net/--c66c9a0048b25c5f9f71f48bbce7ebb5.png)

+ 日志提取失败
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--b806de95130bae50074ac052a3eca28e.png)
   + 错误：日志提取报主机未被注册
   + 解决方案，在job配置中配置ip白名单
      + ![image.png](http://xwyhhhh1.test.upcdn.net/--603b36dd7f76925fa5817d03a9dcb0fa.png)

### 作业平台

+ 作业执行历史中完整路径不显示
   + ![img](http://xwyhhhh1.test.upcdn.net/--5dec97cf109f3bf505092c1ad81dd9a7.png)
   + 问题：在作业平台 作业执行 历史执行详情中，完整的日志不再显示
   + 解决方案：重启gse以及job，然后重新执行，./bkcli restart gse
      ./bkcli restart job

+ 访问job突然出现问题
   + ![6MGF6SPVXQ999_1P.png](http://xwyhhhh1.test.upcdn.net/--8ba2da674b0c31acfcbd5a0f2dfa605d.png)
   + 问题：Internal Server Error
   + 解决方案：查看进程是否正常，./bkcli status job，./bkcli check job，没问题查看权限平台的权限模板查看是否有作业平台的模板，不存在则手动生成即可
      + source /data/install/tools.sh
         bkiam_migrate job
      + ![BKO57OSE3`R0SON5P~Q.png](http://xwyhhhh1.test.upcdn.net/--f6616f94ea2a198585880cf39b2caa23.png)

### 用户管理

+ 删除用户之后，重新创建该用户错误

   + ![img](http://xwyhhhh1.test.upcdn.net/--6725d53f51f1b1c7f14dcbebf4efd22c.png)

   + 问题：重新创建该用户时报错，该目录下用户名已存在

   + 解决方案

      + mysql --login-path=mysql-default

         select * from bk_user.profiles_profile\G #找到恢复用户的id

         update bk_user.profiles_profile set enabled=1, status='NORMAL' where id=想要恢复的id;

      + 然后重新创建

+ 接入AD域失败

   + ![image.png](http://xwyhhhh1.test.upcdn.net/--c05e78f26143d562889fd176df37cce4.png)

   + 问题：接入ad域同步用户失败

   + 解决办法：节点信息中字段需要大写（配置格式不对）

   + ![image.png](http://xwyhhhh1.test.upcdn.net/--08a47c647d5c77d9f817ecd18a34a6c5.png)

   + MAD拉取用户失败

      ![img](http://xwyhhhh1.test.upcdn.net/--6d0fe827abbf09f5e0cd321a57d22c64.png)

   + 问题：过了两周后突然发现域账号无法登录蓝鲸，去【用户管理】查看，发现组织还在，人没了

   + 解决方案：重新拉取用户，前端显示【同步成功】，但还是没有人，查看日志报错,django.db.utils.IntegrityError: (1062, "Duplicate entry '3dc73067d71a502bdd5f812f7be814f4a901b72949e3aeb97b3e30c374043ec6' for key 'code'")

   + 此为属性值重复，导致拉取MAD失败

   + 在数据库中查找此字段，删除一个，问题解除

### 标准运维

+ 标准运维执行报错
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--1a3657d1af00c5b9e2223fe602449cde.png)
   + 问题：请求参数 [ip_list] custom_query_id|target_server] 缺失或不合法, exception: None
      bk_biz_id 2 
   + 解决方案：蓝鲸业务的id为2这个IP不属于当前业务，或者云区域ID没填，配置平台查看该服务器不属于蓝鲸业务。切换业务即可

+ 标准运维部署saas应用超时
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--465ddf9666f60a144655de35a71cd066.png)
   + 问题部署saas tim out
   + 修改 paas_agent 配置文件内的 `EXECUTE_TIME_LIMIT` 配置项
   + 修改 open_paas 配置文件EVENT_STATE_EXPIRE_SECONDS = 3600
   + 参考文档 https://bk.tencent.com/s-mart/community/question/1405

+ 标准运维套餐部署报错
   + ![image.png](http://xwyhhhh1.test.upcdn.net/--0e1c206a081e38785f5843a0f4ff4c99.png)
   + 问题： Ip校验失败，请确认输入的ip 是否合法
   + 解决方案，查看ip是否安装agent，部署套餐之前请检验ip的真实性及agent是否安装

### 权限中心

+ 修改公网访问端口后 权限中心无法打开

   + ![img](http://xwyhhhh1.test.upcdn.net/--45135d7fcbb70c8d3fa741f601b50370.PNG)

   + 问题：修改公网域名及访问端口后权限中心无法打开，DOM文件解析失败

      + 修改首页文件/data/bkce/paas_agent/apps/projects/bk_iam/code/bk_iam/resources/templates/index.html

         将 document.domain = '{{ SESSION_COOKIE_DOMAIN }}'修改为自定义域名，写死成了自定义的域名 document.domain = 'paas.cmdb-hihonor.com'

         环境变量SESSION_COOKIE_DOMAIN携带了域名和端口号导致dom无法正常解析

      + 建立在其他正常基础上，日志服务端不报错的基础上

+ 权限中心应用报错

   + ![image.png](http://xwyhhhh1.test.upcdn.net/--eeff3f50a93b1611de988a31b3ffe385.png)
   + 问题：权限中心点击我的审批出现错误，报错502
   + 解决方案：请确认是否部署了itsm应用，若无则手动部署

